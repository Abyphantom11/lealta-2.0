generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model BrandingConfig {
  id             String   @id @default(cuid())
  businessId     String   @unique
  businessName   String?
  primaryColor   String?
  secondaryColor String?
  accentColor    String?
  logoUrl        String?
  carouselImages String[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  Business       Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
}

model Business {
  id                    String                 @id @default(cuid())
  name                  String
  slug                  String                 @unique
  subdomain             String                 @unique
  customDomain          String?
  subscriptionPlan      SubscriptionPlan       @default(BASIC)
  isActive              Boolean                @default(true)
  settings              Json?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  clientTheme           String?                @default("moderno")
  qrBrandingConfig      Json?                  @default("{}")
  qrMensajeBienvenida   String?                @default("Â¡Te esperamos!")
  qrMostrarLogo         Boolean                @default(true)
  clientThemeConfig     Json?                  @default("{}")
  subscriptionId        String?
  subscriptionStatus    String?
  planId                String?
  customerId            String?
  subscriptionStartDate DateTime?
  subscriptionEndDate   DateTime?
  trialEndsAt           DateTime?
  BrandingConfig        BrandingConfig?
  BusinessGoals         BusinessGoals?
  Cliente               Cliente[]
  Consumo               Consumo[]
  GuestConsumo          GuestConsumo[]
  HostTracking          HostTracking[]
  Location              Location[]
  MenuCategory          MenuCategory[]
  PaymentHistory        PaymentHistory[]
  PortalBanner          PortalBanner[]
  PortalFavoritoDelDia  PortalFavoritoDelDia[]
  PortalPromocion       PortalPromocion[]
  PortalRecompensa      PortalRecompensa[]
  PortalTarjetasConfig  PortalTarjetasConfig?
  Promotor              Promotor[]
  PuntosConfig          PuntosConfig?
  QRLink                QRLink[]
  ReservationService    ReservationService[]
  User                  User[]
  Visita                Visita[]

    // WhatsApp Business Relations
  WhatsAppTemplate      WhatsAppTemplate[]
  WhatsAppOptOut        WhatsAppOptOut[]
  WhatsAppRateLimit     WhatsAppRateLimit[]
  WhatsAppCampaign      WhatsAppCampaign[]
  WhatsAppMessage       WhatsAppMessage[]
  WhatsAppWebhook       WhatsAppWebhook[]
  
  // WhatsApp Subaccounts & Queue System
  WhatsAppAccount       WhatsAppAccount[]
  WhatsAppQueue         WhatsAppQueue[]
  WhatsAppWorkerStatus  WhatsAppWorkerStatus[]
  
  // WhatsApp Analytics
  WhatsAppAnalytics     WhatsAppAnalytics[]
  WhatsAppCampaignAnalytics WhatsAppCampaignAnalytics[]
  WhatsAppClientAnalytics WhatsAppClientAnalytics[]
  WhatsAppSegment       WhatsAppSegment[]
  WhatsAppABTest        WhatsAppABTest[]
  WhatsAppInsight       WhatsAppInsight[]
}

model BusinessGoals {
  id                   String   @id @default(cuid())
  businessId           String   @unique
  dailyRevenue         Float    @default(100)
  weeklyRevenue        Float    @default(700)
  monthlyRevenue       Float    @default(3000)
  dailyClients         Int      @default(5)
  weeklyClients        Int      @default(25)
  monthlyClients       Int      @default(100)
  dailyTransactions    Int      @default(8)
  weeklyTransactions   Int      @default(50)
  monthlyTransactions  Int      @default(200)
  targetTicketAverage  Float    @default(20)
  targetRetentionRate  Float    @default(70)
  targetConversionRate Float    @default(80)
  targetTopClient      Float    @default(150)
  targetActiveClients  Int      @default(50)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  Business             Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

model PaymentHistory {
  id             String   @id @default(cuid())
  businessId     String
  transactionId  String   @unique
  subscriptionId String?
  amount         Float
  currency       String   @default("USD")
  status         String
  paymentMethod  String?
  customerId     String?
  paddleData     Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([transactionId])
  @@index([subscriptionId])
  @@index([createdAt])
  @@map("PaymentHistory")
}

model Cliente {
  id               String           @id @default(cuid())
  businessId       String
  cedula           String
  nombre           String
  correo           String
  telefono         String
  puntos           Int              @default(0)
  puntosAcumulados Int              @default(0)
  totalVisitas     Int              @default(0)
  totalGastado     Float            @default(0)
  defaultCount     Int              @default(0)
  riskLevel        String           @default("LOW")
  lastLogin        DateTime?
  portalViews      Int              @default(0)
  registeredAt     DateTime         @default(now())
  Business         Business         @relation(fields: [businessId], references: [id], onDelete: Cascade)
  Consumo          Consumo[]
  HistorialCanje   HistorialCanje[]
  HostTracking     HostTracking[]
  Reservation      Reservation[]
  TarjetaLealtad   TarjetaLealtad?
  VisitLog         VisitLog[]
  Visita           Visita[]

  // WhatsApp Relations  
  WhatsAppOptOut  WhatsAppOptOut[]
  WhatsAppMessage WhatsAppMessage[]
  WhatsAppQueueJob WhatsAppQueueJob[]
  WhatsAppClientAnalytics WhatsAppClientAnalytics?

  @@unique([businessId, cedula])
}

model ConfiguracionTarjeta {
  id                  String   @id @default(cuid())
  businessId          String   @unique
  nivel               String
  nombrePersonalizado String
  textoCalidad        String
  puntosMinimos       Int      @default(0)
  gastosMinimos       Float    @default(0)
  visitasMinimas      Int      @default(0)
  beneficio           String?
  beneficiosExtra     Json?
  colores             Json
  activa              Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([businessId, nivel])
}

model Consumo {
  id             String        @id @default(cuid())
  businessId     String
  clienteId      String
  locationId     String
  productos      Json
  total          Float
  puntos         Int           @default(0)
  empleadoId     String
  pagado         Boolean       @default(false)
  metodoPago     String?
  registeredAt   DateTime      @default(now())
  paidAt         DateTime?
  ticketImageUrl String?
  ocrText        String?
  Business       Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  Cliente        Cliente       @relation(fields: [clienteId], references: [id])
  User           User          @relation(fields: [empleadoId], references: [id])
  Location       Location      @relation(fields: [locationId], references: [id])
  GuestConsumo   GuestConsumo?
}

model EmailLog {
  id           String    @id @default(cuid())
  to           String
  from         String
  subject      String
  type         String
  resendId     String?
  status       String    @default("pending")
  errorMessage String?
  businessId   String?
  sentAt       DateTime  @default(now())
  deliveredAt  DateTime?
  metadata     Json?

  @@index([sentAt])
  @@index([status])
  @@index([to])
  @@index([type])
}

model EmailVerification {
  id           String    @id @default(cuid())
  email        String
  code         String
  type         String    @default("email-verification")
  businessId   String?
  businessName String?
  verified     Boolean   @default(false)
  attempts     Int       @default(0)
  maxAttempts  Int       @default(3)
  expiresAt    DateTime
  verifiedAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  metadata     Json?

  @@unique([email, code, type])
  @@index([code])
  @@index([email])
  @@index([expiresAt])
}

model EstadisticaVisita {
  id                 String   @id @default(cuid())
  fecha              DateTime
  periodo            String
  totalVisitas       Int      @default(0)
  visitasRegistradas Int      @default(0)
  visitasAnonimas    Int      @default(0)
  sesionesUnicas     Int      @default(0)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([fecha, periodo])
}

model GuestConsumo {
  id             String       @id @default(cuid())
  businessId     String
  hostTrackingId String
  consumoId      String       @unique
  guestCedula    String?
  guestName      String?
  createdAt      DateTime     @default(now())
  Business       Business     @relation(fields: [businessId], references: [id], onDelete: Cascade)
  Consumo        Consumo      @relation(fields: [consumoId], references: [id], onDelete: Cascade)
  HostTracking   HostTracking @relation(fields: [hostTrackingId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([consumoId])
  @@index([hostTrackingId])
}

model HistorialCanje {
  id                String   @id @default(cuid())
  businessId        String?
  clienteId         String
  clienteNombre     String
  clienteCedula     String
  recompensaId      String
  recompensaNombre  String
  puntosDescontados Int
  empleadoId        String?
  metadata          Json?
  createdAt         DateTime @default(now())
  Cliente           Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  User              User?    @relation(fields: [empleadoId], references: [id])

  @@index([businessId])
  @@index([clienteId])
  @@index([createdAt])
}

model HostTracking {
  id              String         @id @default(cuid())
  businessId      String
  reservationId   String         @unique
  clienteId       String
  reservationName String
  tableNumber     String?
  reservationDate DateTime
  guestCount      Int
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  GuestConsumo    GuestConsumo[]
  Business        Business       @relation(fields: [businessId], references: [id], onDelete: Cascade)
  Cliente         Cliente        @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  Reservation     Reservation    @relation(fields: [reservationId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([clienteId])
  @@index([isActive])
  @@index([reservationDate])
  @@index([reservationId])
  @@index([tableNumber])
}

model Location {
  id         String    @id @default(cuid())
  businessId String
  name       String
  createdAt  DateTime  @default(now())
  Consumo    Consumo[]
  Business   Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
}

model MenuCategory {
  id                 String         @id @default(cuid())
  businessId         String
  nombre             String
  descripcion        String?
  orden              Int            @default(0)
  activo             Boolean        @default(true)
  icono              String?
  parentId           String?
  Business           Business       @relation(fields: [businessId], references: [id], onDelete: Cascade)
  MenuCategory       MenuCategory?  @relation("MenuCategoryToMenuCategory", fields: [parentId], references: [id], onDelete: Cascade)
  other_MenuCategory MenuCategory[] @relation("MenuCategoryToMenuCategory")
  MenuProduct        MenuProduct[]

  @@unique([businessId, nombre, parentId])
}

model MenuProduct {
  id            String       @id @default(cuid())
  categoryId    String
  nombre        String
  descripcion   String?
  precio        Float?
  precioVaso    Float?
  precioBotella Float?
  tipoProducto  String       @default("simple")
  disponible    Boolean      @default(true)
  destacado     Boolean      @default(false)
  orden         Int          @default(0)
  imagenUrl     String?
  opciones      Json?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  MenuCategory  MenuCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([categoryId, nombre])
}

model PortalBanner {
  id          String   @id @default(cuid())
  businessId  String
  title       String
  description String?
  imageUrl    String?
  linkUrl     String?
  dia         String?
  active      Boolean  @default(true)
  orden       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  Business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([active])
  @@index([businessId])
  @@index([orden])
}

model PortalConfig {
  id               String   @id @default(cuid())
  businessId       String   @unique
  banners          Json
  promociones      Json
  eventos          Json
  recompensas      Json
  favoritoDelDia   Json?
  colores          Json?
  logo             String?
  isActive         Boolean  @default(true)
  updatedAt        DateTime @updatedAt
  updatedBy        String
  promocionesTitle String?  @default("Promociones Especiales")
  recompensasTitle String?  @default("Recompensas")
}

model PortalFavoritoDelDia {
  id            String   @id @default(cuid())
  businessId    String
  productName   String
  description   String?
  imageUrl      String?
  originalPrice String?
  specialPrice  String?
  specialOffer  String?
  dia           String?
  active        Boolean  @default(true)
  date          DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  Business      Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([active])
  @@index([businessId])
  @@index([date])
}

model PortalPromocion {
  id          String    @id @default(cuid())
  businessId  String
  title       String
  description String?
  imageUrl    String?
  discount    String?
  validUntil  DateTime?
  dia         String?
  active      Boolean   @default(true)
  orden       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  Business    Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([active])
  @@index([businessId])
  @@index([orden])
  @@index([validUntil])
}

model PortalRecompensa {
  id          String   @id @default(cuid())
  businessId  String
  title       String
  description String?
  imageUrl    String?
  pointsCost  Int
  category    String?
  active      Boolean  @default(true)
  orden       Int      @default(0)
  stock       Int?
  unlimited   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  Business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([active])
  @@index([businessId])
  @@index([category])
  @@index([orden])
  @@index([pointsCost])
}

model PortalTarjetasConfig {
  id             String   @id @default(cuid())
  businessId     String   @unique
  showLevels     Boolean  @default(true)
  showProgress   Boolean  @default(true)
  showBenefits   Boolean  @default(true)
  showPointsInfo Boolean  @default(true)
  levelsConfig   Json?
  pointsConfig   Json?
  visualConfig   Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  Business       Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
}

model Promotor {
  id          String        @id @default(cuid())
  businessId  String
  nombre      String
  telefono    String?
  email       String?
  activo      Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  createdBy   String?
  Business    Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  Reservation Reservation[]

  @@unique([businessId, nombre])
  @@index([activo])
  @@index([businessId])
}

model PuntosConfig {
  id                String   @id @default(cuid())
  businessId        String   @unique
  puntosPorDolar    Int      @default(2)
  bonusPorRegistro  Int      @default(100)
  maxPuntosPorDolar Int      @default(10)
  maxBonusRegistro  Int      @default(1000)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  Business          Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
}

model Reservation {
  id                 String              @id @default(cuid())
  businessId         String
  clienteId          String?
  serviceId          String
  slotId             String
  reservationNumber  String              @unique
  status             ReservationStatus   @default(PENDING)
  customerName       String
  customerEmail      String
  customerPhone      String?
  guestCount         Int
  specialRequests    String?
  notes              String?
  totalPrice         Decimal?            @db.Decimal(10, 2)
  paidAmount         Decimal             @default(0) @db.Decimal(10, 2)
  isPaid             Boolean             @default(false)
  paymentReference   String?
  reservedAt         DateTime
  confirmedAt        DateTime?
  checkedInAt        DateTime?
  completedAt        DateTime?
  cancelledAt        DateTime?
  reminderSent       Boolean             @default(false)
  reminderSentAt     DateTime?
  source             String              @default("manual")
  metadata           Json?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  promotorId         String?             @default("whatsapp-default")
  tableNumber        String?
  HostTracking       HostTracking?
  Cliente            Cliente?            @relation(fields: [clienteId], references: [id])
  Promotor           Promotor?           @relation(fields: [promotorId], references: [id])
  ReservationService ReservationService  @relation(fields: [serviceId], references: [id])
  ReservationSlot    ReservationSlot     @relation(fields: [slotId], references: [id])
  ReservationQRCode  ReservationQRCode[]

  @@index([businessId])
  @@index([clienteId])
  @@index([promotorId])
  @@index([reservedAt])
  @@index([serviceId])
  @@index([slotId])
  @@index([status])
}

model ReservationQRCode {
  id            String       @id @default(cuid())
  businessId    String
  qrToken       String       @unique
  qrData        String
  status        QRCodeStatus @default(ACTIVE)
  expiresAt     DateTime
  usedAt        DateTime?
  usedBy        String?
  scanCount     Int          @default(0)
  lastScannedAt DateTime?
  metadata      Json?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  reservationId String
  Reservation   Reservation  @relation(fields: [reservationId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([expiresAt])
  @@index([qrToken])
  @@index([reservationId])
  @@index([status])
}

model ReservationService {
  id              String            @id @default(cuid())
  businessId      String
  name            String
  description     String?
  capacity        Int               @default(50)
  duration        Int               @default(120)
  price           Decimal?          @db.Decimal(10, 2)
  isActive        Boolean           @default(true)
  metadata        Json?
  sortOrder       Int               @default(0)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  Reservation     Reservation[]
  Business        Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  ReservationSlot ReservationSlot[]

  @@index([businessId])
  @@index([isActive])
}

model ReservationSlot {
  id                 String             @id @default(cuid())
  businessId         String
  serviceId          String
  date               DateTime           @db.Date
  startTime          DateTime
  endTime            DateTime
  capacity           Int
  reservedCount      Int                @default(0)
  status             SlotStatus         @default(AVAILABLE)
  price              Decimal?           @db.Decimal(10, 2)
  notes              String?
  isRecurring        Boolean            @default(false)
  recurringId        String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  Reservation        Reservation[]
  ReservationService ReservationService @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([date])
  @@index([serviceId])
  @@index([status])
}

model SinReserva {
  id             String   @id @default(cuid())
  businessId     String
  numeroPersonas Int
  fecha          DateTime
  hora           String
  registradoPor  String?
  notas          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([businessId])
  @@index([createdAt])
  @@index([fecha])
}

model TarjetaLealtad {
  id               String   @id @default(cuid())
  clienteId        String   @unique
  businessId       String
  nivel            String
  fechaAsignacion  DateTime @default(now())
  asignacionManual Boolean  @default(false)
  activa           Boolean  @default(true)
  puntosProgreso   Int      @default(0)
  historicoNiveles Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  Cliente          Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)
}

model User {
  id             String           @id @default(cuid())
  businessId     String
  email          String
  passwordHash   String
  name           String?
  role           Role             @default(STAFF)
  createdBy      String?
  isActive       Boolean          @default(true)
  lastLogin      DateTime?
  permissions    Json?
  loginAttempts  Int              @default(0)
  lockedUntil    DateTime?
  sessionToken   String?
  sessionExpires DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  Consumo        Consumo[]
  HistorialCanje HistorialCanje[]
  business       Business         @relation(fields: [businessId], references: [id], onDelete: Cascade)
  User           User?            @relation("UserToUser", fields: [createdBy], references: [id])
  other_User     User[]           @relation("UserToUser")

  @@unique([businessId, email])
}

model VisitLog {
  id        String   @id @default(cuid())
  clienteId String
  action    String
  metadata  Json?
  timestamp DateTime @default(now())
  Cliente   Cliente  @relation(fields: [clienteId], references: [id])
}

model Visita {
  id           String   @id @default(cuid())
  clienteId    String?
  sessionId    String
  businessId   String
  timestamp    DateTime @default(now())
  userAgent    String?
  ip           String?
  referrer     String?
  path         String   @default("/cliente")
  isRegistered Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  Business     Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  Cliente      Cliente? @relation(fields: [clienteId], references: [id])

  @@index([businessId])
  @@index([clienteId])
  @@index([path])
  @@index([sessionId])
  @@index([timestamp])
}

model QRLink {
  id          String    @id @default(cuid())
  shortId     String    @unique
  name        String
  description String?
  targetUrl   String
  backupUrl   String?
  businessId  String?
  isActive    Boolean   @default(true)
  clickCount  Int       @default(0)
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  clicks      QRClick[]
  Business    Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([shortId])
  @@index([businessId])
  @@index([isActive])
  @@index([createdAt])
}

model QRClick {
  id        String   @id @default(cuid())
  qrLinkId  String
  ipAddress String?
  userAgent String?  @db.VarChar(500)
  referer   String?
  createdAt DateTime @default(now())
  qrLink    QRLink   @relation(fields: [qrLinkId], references: [id], onDelete: Cascade)

  @@index([qrLinkId])
  @@index([createdAt])
}

enum QRCodeStatus {
  ACTIVE
  USED
  EXPIRED
  CANCELLED
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  CHECKED_IN
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum Role {
  SUPERADMIN
  ADMIN
  STAFF
}

enum SlotStatus {
  AVAILABLE
  RESERVED
  FULL
  BLOCKED
}

enum SubscriptionPlan {
  BASIC
  PRO
  ENTERPRISE
}

// ========================================
// ðŸ“± WHATSAPP BUSINESS COMPLIANCE SYSTEM
// ========================================

model WhatsAppTemplate {
  id                 String    @id @default(cuid())
  businessId         String
  name               String
  category           String // MARKETING, UTILITY, AUTHENTICATION
  language           String    @default("es")
  status             String    @default("PENDING") // PENDING, APPROVED, REJECTED
  content            Json // Template structure with header, body, footer, buttons
  whatsappTemplateId String? // Official WhatsApp template ID after approval
  submittedAt        DateTime  @default(now())
  approvedAt         DateTime?
  rejectedAt         DateTime?
  rejectionReason    String?

  Business         Business           @relation(fields: [businessId], references: [id], onDelete: Cascade)
  WhatsAppCampaign WhatsAppCampaign[]
  WhatsAppMessage  WhatsAppMessage[]
  WhatsAppQueue    WhatsAppQueue[]

  @@index([businessId, status])
  @@index([whatsappTemplateId])
}

model WhatsAppOptOut {
  id          String    @id @default(cuid())
  clienteId   String?
  businessId  String
  phoneNumber String // Normalized format +593XXXXXXXXX
  method      String // STOP_KEYWORD, MANUAL, REPORTED, BLOCK
  optedOutAt  DateTime  @default(now())
  optedBackIn Boolean   @default(false)
  optedBackAt DateTime?

  Cliente  Cliente? @relation(fields: [clienteId], references: [id], onDelete: SetNull)
  Business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([phoneNumber, businessId])
  @@index([phoneNumber])
  @@index([businessId])
}

model WhatsAppRateLimit {
  id                 String    @id @default(cuid())
  businessId         String
  date               String // YYYY-MM-DD format
  tier               String    @default("TIER_1") // TIER_1, TIER_2, TIER_3
  dailyLimit         Int       @default(1000)
  monthlyLimit       Int       @default(1000)
  messagesCount      Int       @default(0)
  conversationsCount Int       @default(0)
  lastMessageAt      DateTime?

  Business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, date])
  @@index([businessId])
}

model WhatsAppCampaign {
  id            String    @id @default(cuid())
  businessId    String
  name          String
  templateId    String?
  customMessage String?
  variables     Json? // Template variables
  filters       Json // Audience filters
  status        String    @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED, CANCELLED
  priority      String    @default("MEDIUM") // LOW, MEDIUM, HIGH
  scheduledAt   DateTime  @default(now())
  startedAt     DateTime?
  completedAt   DateTime?

  // Metrics
  totalTargeted  Int @default(0)
  totalSent      Int @default(0)
  totalDelivered Int @default(0)
  totalRead      Int @default(0)
  totalReplied   Int @default(0)
  totalFailed    Int @default(0)
  totalOptedOut  Int @default(0)

  // Cost tracking
  estimatedCost Float? @default(0)
  actualCost    Float? @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Business         Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  WhatsAppTemplate WhatsAppTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  WhatsAppMessage  WhatsAppMessage[]

  @@index([businessId, status])
  @@index([scheduledAt])
}

model WhatsAppMessage {
  id            String  @id @default(cuid())
  campaignId    String?
  businessId    String
  accountId     String? // WhatsApp account used for sending
  clienteId     String?
  phoneNumber   String // Normalized +593XXXXXXXXX
  templateId    String?
  customMessage String?
  variables     Json?

  // Status tracking
  status      String @default("PENDING") // PENDING, SENDING, SENT, DELIVERED, READ, FAILED, CANCELLED
  priority    String @default("MEDIUM")
  attempts    Int    @default(0)
  maxAttempts Int    @default(3)

  // Twilio integration
  twilioSid    String? // Twilio message SID
  twilioStatus String? // Twilio status
  twilioError  String? // Twilio error message

  // Timestamps
  scheduledAt   DateTime  @default(now())
  sentAt        DateTime?
  deliveredAt   DateTime?
  readAt        DateTime?
  failedAt      DateTime?
  lastAttemptAt DateTime?

  // Cost
  cost Float? @default(0.055) // USD per message

  // Response tracking
  hasResponse  Boolean   @default(false)
  responseText String?
  responseAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Business         Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  Cliente          Cliente?          @relation(fields: [clienteId], references: [id], onDelete: SetNull)
  WhatsAppCampaign WhatsAppCampaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  WhatsAppTemplate WhatsAppTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  WhatsAppAccount  WhatsAppAccount?  @relation("AccountMessages", fields: [accountId], references: [id], onDelete: SetNull)
  QueueJob         WhatsAppQueueJob?

  @@index([businessId, status])
  @@index([phoneNumber])
  @@index([campaignId])
  @@index([scheduledAt])
  @@index([sentAt])
}

model WhatsAppWebhook {
  id           String    @id @default(cuid())
  twilioSid    String    @unique
  businessId   String?
  messageId    String? // Reference to WhatsAppMessage
  webhookType  String // status, message, error
  status       String? // delivered, read, failed, etc.
  errorCode    String?
  errorMessage String?
  rawPayload   Json // Complete webhook payload
  processed    Boolean   @default(false)
  processedAt  DateTime?

  createdAt DateTime @default(now())

  Business Business? @relation(fields: [businessId], references: [id], onDelete: SetNull)

  @@index([twilioSid])
  @@index([messageId])
  @@index([businessId])
  @@index([processed])
  @@index([createdAt])
}

// ========================================
// ðŸ“± WHATSAPP SUBACCOUNTS & QUEUE SYSTEM
// ========================================

model WhatsAppAccount {
  id                    String   @id @default(cuid())
  businessId            String
  name                  String   // "NÃºmero Principal", "Soporte", etc.
  phoneNumber           String   @unique // +593XXXXXXXXX
  twilioAccountSid      String?
  twilioSubaccountSid   String?  // Twilio subaccount
  twilioAuthToken       String?
  whatsappBusinessId    String?  // Meta Business ID
  wabaAccessToken       String?  // WABA access token
  status                String   @default("PENDING") // PENDING, ACTIVE, SUSPENDED, EXPIRED
  
  // Configuration
  isDefault             Boolean  @default(false)
  isPrimary             Boolean  @default(false)
  maxDailyMessages      Int      @default(1000)
  maxConcurrentMessages Int      @default(10)
  
  // Verification status
  verificationStatus    String   @default("UNVERIFIED") // UNVERIFIED, PENDING, VERIFIED
  verifiedAt            DateTime?
  
  // Templates and compliance
  templatesApproved     Int      @default(0)
  qualityRating         String?  @default("UNKNOWN") // GREEN, YELLOW, RED, UNKNOWN
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  Business              Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  // Relations for queue system
  WhatsAppQueue         WhatsAppQueue[]
  WhatsAppMessage       WhatsAppMessage[] @relation("AccountMessages")
  
  @@index([businessId])
  @@index([phoneNumber])
  @@index([status])
  @@index([isPrimary])
}

model WhatsAppQueue {
  id                String   @id @default(cuid())
  businessId        String
  accountId         String   // WhatsApp account to use
  name              String   // "Promociones Viernes", "Bienvenida Nuevos"
  description       String?
  
  // Queue configuration
  priority          Int      @default(5) // 1-10 (10 = highest)
  maxRetries        Int      @default(3)
  retryDelayMinutes Int      @default(5)
  batchSize         Int      @default(50)
  rateLimitPerHour  Int      @default(100)
  
  // Scheduling
  scheduledAt       DateTime?
  startTime         String?  // "09:00" - Hour to start sending
  endTime           String?  // "18:00" - Hour to stop sending
  timezone          String   @default("America/Guayaquil")
  
  // Status
  status            String   @default("DRAFT") // DRAFT, SCHEDULED, PROCESSING, PAUSED, COMPLETED, FAILED
  startedAt         DateTime?
  completedAt       DateTime?
  pausedAt          DateTime?
  
  // Progress tracking
  totalMessages     Int      @default(0)
  sentMessages      Int      @default(0)
  failedMessages    Int      @default(0)
  pendingMessages   Int      @default(0)
  
  // Template and content
  templateId        String?
  customMessage     String?
  variables         Json?
  
  // Target audience
  audienceFilters   Json     // Filtros para seleccionar audiencia
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  Business          Business           @relation(fields: [businessId], references: [id], onDelete: Cascade)
  WhatsAppAccount   WhatsAppAccount    @relation(fields: [accountId], references: [id], onDelete: Cascade)
  WhatsAppTemplate  WhatsAppTemplate?  @relation(fields: [templateId], references: [id], onDelete: SetNull)
  QueueJobs         WhatsAppQueueJob[]
  
  @@index([businessId])
  @@index([accountId])
  @@index([status])
  @@index([priority])
  @@index([scheduledAt])
}

model WhatsAppQueueJob {
  id                String   @id @default(cuid())
  queueId           String
  messageId         String?  // Reference to WhatsAppMessage when processed
  
  // Job data
  targetPhone       String   // +593XXXXXXXXX
  targetClientId    String?
  messageContent    String
  variables         Json?
  
  // Job status
  status            String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED, RETRYING
  priority          Int      @default(5)
  attempts          Int      @default(0)
  maxAttempts       Int      @default(3)
  
  // Scheduling
  scheduledAt       DateTime @default(now())
  processAt         DateTime @default(now()) // When to process this job
  
  // Execution tracking
  startedAt         DateTime?
  completedAt       DateTime?
  failedAt          DateTime?
  lastAttemptAt     DateTime?
  nextAttemptAt     DateTime?
  
  // Error handling
  lastError         String?
  errorCount        Int      @default(0)
  
  // Result tracking
  twilioSid         String?  // Twilio message SID when sent
  deliveryStatus    String?  // Message delivery status
  cost              Float?   @default(0.055)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  Queue             WhatsAppQueue    @relation(fields: [queueId], references: [id], onDelete: Cascade)
  Cliente           Cliente?         @relation(fields: [targetClientId], references: [id], onDelete: SetNull)
  Message           WhatsAppMessage? @relation(fields: [messageId], references: [id], onDelete: SetNull)

  @@unique([messageId]) // Asegurar relaciÃ³n uno-a-uno con mensaje
  
  @@index([queueId])
  @@index([status])
  @@index([processAt])
  @@index([priority])
  @@index([targetPhone])
  @@index([scheduledAt])
}

model WhatsAppWorkerStatus {
  id                String   @id @default(cuid())
  workerName        String   @unique // "worker-1", "worker-2", etc.
  businessId        String?  // Optional: worker assigned to specific business
  
  // Worker state
  status            String   @default("IDLE") // IDLE, BUSY, OFFLINE, ERROR
  currentQueueId    String?
  currentJobId      String?
  
  // Performance metrics
  jobsProcessed     Int      @default(0)
  jobsSuccessful    Int      @default(0)
  jobsFailed        Int      @default(0)
  averageJobTime    Int      @default(0) // milliseconds
  
  // Health monitoring
  lastHeartbeat     DateTime @default(now())
  lastJobAt         DateTime?
  errorCount        Int      @default(0)
  lastError         String?
  
  // Resource usage
  memoryUsage       Float?   // MB
  cpuUsage          Float?   // %
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  Business          Business? @relation(fields: [businessId], references: [id], onDelete: SetNull)
  
  @@index([status])
  @@index([businessId])
  @@index([lastHeartbeat])
}

// ========================================
// ðŸ“Š WHATSAPP ANALYTICS & REPORTING
// ========================================

model WhatsAppAnalytics {
  id                    String   @id @default(cuid())
  businessId            String
  date                  String   @unique // YYYY-MM-DD
  
  // Daily metrics
  totalMessagesReceived Int      @default(0)
  totalMessagesSent     Int      @default(0)
  totalDelivered        Int      @default(0)
  totalFailed           Int      @default(0)
  totalReplied          Int      @default(0)
  
  // Engagement metrics
  deliveryRate          Float    @default(0)    // %
  failureRate           Float    @default(0)    // %
  responseRate          Float    @default(0)    // %
  
  // Business metrics
  totalClients          Int      @default(0)
  newClients            Int      @default(0)
  activeClients         Int      @default(0)
  optedOutClients       Int      @default(0)
  
  // Financial metrics
  totalCost             Float    @default(0)    // USD
  averageCostPerMessage Float?   @default(0.055)
  
  // Queue metrics
  totalQueuesProcessed  Int      @default(0)
  queuesCompleted       Int      @default(0)
  queuesFailed          Int      @default(0)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  Business              Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@index([businessId])
  @@index([date])
}

model WhatsAppCampaignAnalytics {
  id                    String   @id @default(cuid())
  campaignId            String   @unique
  businessId            String
  
  // Campaign info
  name                  String
  startDate             DateTime
  endDate               DateTime?
  
  // Performance metrics
  totalTargeted         Int      @default(0)
  totalSent             Int      @default(0)
  totalDelivered        Int      @default(0)
  totalRead             Int      @default(0)
  totalReplied          Int      @default(0)
  totalFailed           Int      @default(0)
  totalOptedOut         Int      @default(0)
  
  // Rates
  deliveryRate          Float    @default(0)    // %
  readRate              Float    @default(0)    // %
  responseRate          Float    @default(0)    // %
  optOutRate            Float    @default(0)    // %
  
  // Financial
  estimatedCost         Float?   @default(0)
  actualCost            Float?   @default(0)
  costPerLead           Float?   @default(0)
  
  // Attribution
  conversions           Int      @default(0)
  revenue               Float?   @default(0)
  roi                   Float?   @default(0)    // %
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  Business              Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@index([businessId])
  @@index([campaignId])
  @@index([startDate])
}

model WhatsAppClientAnalytics {
  id                    String   @id @default(cuid())
  clienteId             String   @unique
  businessId            String
  
  // Client info
  phoneNumber           String
  
  // Engagement
  totalMessagesReceived Int      @default(0)
  totalMessagesSent     Int      @default(0)
  totalReplies          Int      @default(0)
  lastMessageDate       DateTime?
  
  // Behavior
  responseRate          Float    @default(0)    // % de mensajes con respuesta
  averageResponseTime   Int?     // minutos
  engagementScore       Int      @default(0)    // 0-100
  
  // Preferences
  preferredHour         Int?     // 0-23
  preferredDayOfWeek    Int?     // 0-6 (0 = Sunday)
  
  // Conversion
  conversions           Int      @default(0)
  revenue               Float?   @default(0)
  
  // Status
  isActive              Boolean  @default(true)
  isOptedOut            Boolean  @default(false)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  Business              Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  Cliente               Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  
  @@index([businessId])
  @@index([clienteId])
  @@index([engagementScore])
  @@index([isOptedOut])
}

model WhatsAppSegment {
  id                    String   @id @default(cuid())
  businessId            String
  name                  String
  description           String?
  
  // Segment criteria
  criteria              Json     // Filtros para segmentar audiencia
  
  // Segment stats
  clientCount           Int      @default(0)
  
  // Targeting
  isActive              Boolean  @default(true)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  Business              Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@index([businessId])
  @@index([isActive])
}

model WhatsAppABTest {
  id                    String   @id @default(cuid())
  businessId            String
  name                  String
  description           String?
  
  // Test configuration
  variantA_name         String
  variantA_message      String
  variantB_name         String
  variantB_message      String
  
  // Test status
  status                String   @default("DRAFT") // DRAFT, RUNNING, PAUSED, COMPLETED
  startDate             DateTime?
  endDate               DateTime?
  
  // Test results
  variantA_sent         Int      @default(0)
  variantA_delivered    Int      @default(0)
  variantA_read         Int      @default(0)
  variantA_replied      Int      @default(0)
  variantA_conversions  Int      @default(0)
  
  variantB_sent         Int      @default(0)
  variantB_delivered    Int      @default(0)
  variantB_read         Int      @default(0)
  variantB_replied      Int      @default(0)
  variantB_conversions  Int      @default(0)
  
  // Winner
  winner                String?  // "A" o "B"
  winningConfidence     Float?   // % (0-100)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  Business              Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@index([businessId])
  @@index([status])
}

model WhatsAppInsight {
  id                    String   @id @default(cuid())
  businessId            String
  
  // Insight metadata
  title                 String
  description           String
  type                  String   // ALERT, RECOMMENDATION, TREND, OPPORTUNITY
  priority              String   @default("MEDIUM") // LOW, MEDIUM, HIGH, CRITICAL
  
  // Insight data
  data                  Json     // Datos del insight
  metric                String?  // MÃ©trica asociada
  value                 String?  // Valor o cambio
  
  // Actions
  actionRecommended     String?
  actionUrl             String?
  
  // Status
  isRead                Boolean  @default(false)
  isActioned            Boolean  @default(false)
  
  createdAt             DateTime @default(now())
  dismissedAt           DateTime?
  
  Business              Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@index([businessId])
  @@index([type])
  @@index([priority])
  @@index([isRead])
}
