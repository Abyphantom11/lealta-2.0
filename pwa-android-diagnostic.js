// PWA Android Analysis & Diagnostic Tool
// Este script analiza todos los aspectos que afectan la instalabilidad PWA en Android

console.log('üîß === PWA ANDROID DIAGNOSTIC TOOL ===');

// 1. INFORMACI√ìN DEL ENTORNO
console.log('\nüì± 1. INFORMACI√ìN DEL ENTORNO');
console.log('User Agent:', navigator.userAgent);
console.log('Plataforma:', navigator.platform);
console.log('Display Mode:', window.matchMedia('(display-mode: standalone)').matches ? 'Standalone' : 'Browser');
console.log('URL actual:', window.location.href);
console.log('Protocolo:', window.location.protocol);
console.log('Hostname:', window.location.hostname);

// 2. VERIFICACI√ìN DE MANIFEST
console.log('\nüìÑ 2. VERIFICACI√ìN DE MANIFEST');
async function checkManifest() {
  try {
    const manifestLink = document.querySelector('link[rel="manifest"]');
    if (!manifestLink) {
      console.error('‚ùå No se encontr√≥ link rel="manifest"');
      return false;
    }
    
    console.log('‚úÖ Link manifest encontrado:', manifestLink.href);
    
    const response = await fetch(manifestLink.href);
    if (!response.ok) {
      console.error('‚ùå Manifest no accesible:', response.status);
      return false;
    }
    
    const manifest = await response.json();
    console.log('üìÑ Manifest content:', manifest);
    
    // Verificar campos cr√≠ticos
    const criticalFields = [
      'name', 'short_name', 'start_url', 'display', 
      'icons', 'theme_color', 'background_color'
    ];
    
    console.log('\nüîç Verificando campos cr√≠ticos:');
    criticalFields.forEach(field => {
      const exists = field in manifest;
      console.log(`${exists ? '‚úÖ' : '‚ùå'} ${field}:`, exists ? manifest[field] : 'MISSING');
    });
    
    // Verificar iconos espec√≠ficamente
    if (manifest.icons && Array.isArray(manifest.icons)) {
      console.log('\nüñºÔ∏è An√°lisis de iconos:');
      manifest.icons.forEach((icon, index) => {
        console.log(`Icon ${index + 1}:`, {
          src: icon.src,
          sizes: icon.sizes,
          type: icon.type || 'image/png'
        });
      });
      
      // Verificar iconos requeridos para Android
      const requiredSizes = ['192x192', '512x512'];
      const hasRequiredSizes = requiredSizes.every(size => 
        manifest.icons.some(icon => icon.sizes && icon.sizes.includes(size))
      );
      
      console.log(`${hasRequiredSizes ? '‚úÖ' : '‚ùå'} Iconos requeridos (192x192, 512x512):`, hasRequiredSizes);
    } else {
      console.error('‚ùå No se encontraron iconos en el manifest');
    }
    
    return true;
  } catch (error) {
    console.error('‚ùå Error verificando manifest:', error);
    return false;
  }
}

// 3. VERIFICACI√ìN DE SERVICE WORKER
console.log('\n‚öôÔ∏è 3. VERIFICACI√ìN DE SERVICE WORKER');
async function checkServiceWorker() {
  if (!('serviceWorker' in navigator)) {
    console.error('‚ùå Service Worker no soportado');
    return false;
  }
  
  console.log('‚úÖ Service Worker soportado');
  
  try {
    const registration = await navigator.serviceWorker.getRegistration();
    if (registration) {
      console.log('‚úÖ Service Worker registrado');
      console.log('Scope:', registration.scope);
      console.log('State:', registration.active ? 'Active' : 'Not Active');
      console.log('Installing:', !!registration.installing);
      console.log('Waiting:', !!registration.waiting);
      
      // Intentar actualizar
      await registration.update();
      console.log('‚úÖ Service Worker actualizado');
      
      return true;
    } else {
      console.log('‚ö†Ô∏è Service Worker no registrado, registrando...');
      const newRegistration = await navigator.serviceWorker.register('/sw.js');
      console.log('‚úÖ Service Worker registrado exitosamente:', newRegistration.scope);
      return true;
    }
  } catch (error) {
    console.error('‚ùå Error con Service Worker:', error);
    return false;
  }
}

// 4. VERIFICACI√ìN DE BEFOREINSTALLPROMPT
console.log('\nüì≤ 4. VERIFICACI√ìN DE BEFOREINSTALLPROMPT');
let hasBeforeInstallPrompt = false;
let deferredPrompt = null;

// Listener para capturar el evento
window.addEventListener('beforeinstallprompt', (e) => {
  console.log('üéâ beforeinstallprompt EVENT CAPTURED!');
  hasBeforeInstallPrompt = true;
  deferredPrompt = e;
  e.preventDefault();
});

// Verificar si ya est√° disponible
setTimeout(() => {
  console.log(`${hasBeforeInstallPrompt ? '‚úÖ' : '‚ùå'} beforeinstallprompt disponible:`, hasBeforeInstallPrompt);
  
  if (deferredPrompt) {
    console.log('‚úÖ Prompt de instalaci√≥n capturado y disponible');
  } else {
    console.log('‚ùå No se captur√≥ prompt de instalaci√≥n');
    
    // Diagnosticar por qu√© no est√° disponible
    console.log('\nüîç DIAGN√ìSTICO - ¬øPor qu√© no est√° disponible?');
    
    // Verificar si ya est√° instalado
    if (window.matchMedia('(display-mode: standalone)').matches) {
      console.log('üî∏ La app ya est√° instalada (modo standalone)');
    }
    
    // Verificar navegador
    const isChrome = /Chrome/.test(navigator.userAgent) && !/Edg/.test(navigator.userAgent);
    const isEdge = /Edg/.test(navigator.userAgent);
    const isFirefox = /Firefox/.test(navigator.userAgent);
    const isSamsung = /SamsungBrowser/.test(navigator.userAgent);
    
    console.log('üî∏ Navegador Chrome:', isChrome);
    console.log('üî∏ Navegador Edge:', isEdge);
    console.log('üî∏ Navegador Firefox:', isFirefox);
    console.log('üî∏ Navegador Samsung:', isSamsung);
    
    // Verificar Android
    const isAndroid = /Android/.test(navigator.userAgent);
    console.log('üî∏ Dispositivo Android:', isAndroid);
    
    // Verificar engagement criteria
    console.log('üî∏ Posibles causas:');
    console.log('   - La app ya fue instalada anteriormente');
    console.log('   - No cumple criterios de engagement (tiempo en sitio)');
    console.log('   - Manifest o Service Worker tienen problemas');
    console.log('   - El navegador no soporta beforeinstallprompt');
    console.log('   - El dominio no cumple requisitos HTTPS');
  }
}, 2000);

// 5. VERIFICACI√ìN DE CRITERIOS PWA
console.log('\n‚úÖ 5. VERIFICACI√ìN DE CRITERIOS PWA');
function checkPWACriteria() {
  const criteria = {
    https: window.location.protocol === 'https:' || window.location.hostname === 'localhost',
    manifest: !!document.querySelector('link[rel="manifest"]'),
    serviceWorker: 'serviceWorker' in navigator,
    responsive: window.innerWidth > 0 && window.innerHeight > 0,
    standalone: window.matchMedia('(display-mode: standalone)').matches
  };
  
  console.log('HTTPS/Localhost:', criteria.https ? '‚úÖ' : '‚ùå');
  console.log('Manifest Link:', criteria.manifest ? '‚úÖ' : '‚ùå');
  console.log('Service Worker Support:', criteria.serviceWorker ? '‚úÖ' : '‚ùå');
  console.log('Responsive Design:', criteria.responsive ? '‚úÖ' : '‚ùå');
  console.log('Ya instalado:', criteria.standalone ? '‚úÖ' : '‚ùå');
  
  const canBeInstallable = criteria.https && criteria.manifest && criteria.serviceWorker && !criteria.standalone;
  console.log('\nüéØ PUEDE SER INSTALABLE:', canBeInstallable ? '‚úÖ S√ç' : '‚ùå NO');
  
  return criteria;
}

// 6. PRUEBAS DE CONEXI√ìN E ICONOS
console.log('\nüñºÔ∏è 6. VERIFICACI√ìN DE ICONOS');
async function testIcons() {
  try {
    const manifestLink = document.querySelector('link[rel="manifest"]');
    if (!manifestLink) return;
    
    const manifest = await fetch(manifestLink.href).then(r => r.json());
    if (!manifest.icons) return;
    
    console.log('Probando accesibilidad de iconos...');
    
    for (const icon of manifest.icons) {
      try {
        const response = await fetch(icon.src);
        console.log(`${response.ok ? '‚úÖ' : '‚ùå'} ${icon.src} (${icon.sizes || 'no size'}) - ${response.status}`);
      } catch (error) {
        console.log(`‚ùå ${icon.src} - Error: ${error.message}`);
      }
    }
  } catch (error) {
    console.error('Error testing icons:', error);
  }
}

// 7. SIMULACI√ìN DE INSTALACI√ìN
console.log('\nüöÄ 7. FUNCI√ìN DE INSTALACI√ìN');
window.testPWAInstall = async function() {
  console.log('üîß Intentando instalaci√≥n PWA...');
  
  if (deferredPrompt) {
    try {
      const result = await deferredPrompt.prompt();
      console.log('‚úÖ Prompt mostrado');
      
      const choiceResult = await deferredPrompt.userChoice;
      console.log('Resultado:', choiceResult.outcome);
      
      if (choiceResult.outcome === 'accepted') {
        console.log('üéâ ¬°Usuario acept√≥ la instalaci√≥n!');
      } else {
        console.log('üòî Usuario rechaz√≥ la instalaci√≥n');
      }
      
      deferredPrompt = null;
    } catch (error) {
      console.error('‚ùå Error en instalaci√≥n:', error);
    }
  } else {
    console.log('‚ùå No hay prompt de instalaci√≥n disponible');
    console.log('üí° Esto puede significar:');
    console.log('   1. La app ya est√° instalada');
    console.log('   2. No cumple criterios PWA');
    console.log('   3. El navegador no soporta instalaci√≥n');
    console.log('   4. Necesita m√°s engagement del usuario');
  }
};

// 8. INFORMACI√ìN ADICIONAL PARA DEBUGGING
console.log('\nüîß 8. INFORMACI√ìN ADICIONAL');
function additionalInfo() {
  console.log('Window size:', `${window.innerWidth}x${window.innerHeight}`);
  console.log('Screen size:', `${screen.width}x${screen.height}`);
  console.log('Device pixel ratio:', window.devicePixelRatio);
  console.log('Online:', navigator.onLine);
  console.log('Connection:', navigator.connection ? navigator.connection.effectiveType : 'No disponible');
  console.log('Touch support:', 'ontouchstart' in window);
  console.log('Vibration support:', 'vibrate' in navigator);
  console.log('Web Share API:', 'share' in navigator);
  console.log('Notification support:', 'Notification' in window);
  console.log('Push messaging:', 'PushManager' in window);
  
  // Verificar almacenamiento
  if ('storage' in navigator && 'estimate' in navigator.storage) {
    navigator.storage.estimate().then(estimate => {
      console.log('Storage quota:', estimate.quota);
      console.log('Storage usage:', estimate.usage);
    });
  }
}

// EJECUTAR TODAS LAS VERIFICACIONES
async function runFullDiagnostic() {
  console.log('\nüîÑ EJECUTANDO DIAGN√ìSTICO COMPLETO...\n');
  
  const manifestOk = await checkManifest();
  const swOk = await checkServiceWorker();
  const criteria = checkPWACriteria();
  await testIcons();
  additionalInfo();
  
  console.log('\nüìä === RESUMEN DEL DIAGN√ìSTICO ===');
  console.log(`Manifest: ${manifestOk ? '‚úÖ' : '‚ùå'}`);
  console.log(`Service Worker: ${swOk ? '‚úÖ' : '‚ùå'}`);
  console.log(`Criterios PWA: ${criteria.https && criteria.manifest && criteria.serviceWorker ? '‚úÖ' : '‚ùå'}`);
  console.log(`beforeinstallprompt: ${hasBeforeInstallPrompt ? '‚úÖ' : '‚ùå'} (verificar en 2 segundos)`);
  
  console.log('\nüí° RECOMENDACIONES:');
  if (!manifestOk) console.log('üî∏ Revisar y corregir manifest.json');
  if (!swOk) console.log('üî∏ Revisar Service Worker');
  if (!criteria.https) console.log('üî∏ Usar HTTPS o localhost');
  if (!hasBeforeInstallPrompt) {
    console.log('üî∏ Para activar beforeinstallprompt en Android Chrome:');
    console.log('   - Usar durante al menos 30 segundos');
    console.log('   - Navegar por diferentes p√°ginas');
    console.log('   - Esperar al menos 5 minutos entre intentos');
    console.log('   - Borrar datos del sitio y volver a intentar');
    console.log('   - Verificar que no est√© ya instalado');
  }
  
  console.log('\nüöÄ Para probar instalaci√≥n manual, ejecuta: testPWAInstall()');
}

// Ejecutar diagn√≥stico autom√°ticamente
runFullDiagnostic();

// Exportar funciones para uso manual
window.pwaDiagnostic = {
  checkManifest,
  checkServiceWorker,
  checkPWACriteria,
  testIcons,
  runFullDiagnostic,
  testPWAInstall: window.testPWAInstall
};
